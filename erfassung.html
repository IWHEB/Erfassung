<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        body {
            font-family: sans-serif;
        }

        .label {
            margin-right: 1em;
        }
    </style>
</head>

<body>
    <div style="display: flex; flex-direction: column;">
        <div style="display: flex; flex-direction: row; justify-content: space-evenly; gap: 3em;">
            <div style="display: flex; flex-direction: column;">
                <h2>Copy-Paste von Whatsapp</h2>
                <textarea onpaste="setTimeout(paste, 200);" style="height:100%; width: 100%;"
                    id="input-text"></textarea>
            </div>
            <div style="display: flex; flex-direction: column; justify-content: center; gap: 3em;">
                <button style="font-size: 300%; font-weight: bold;" onclick="clearInputs()">‚ùå</button>
                <button style="font-size: 300%; font-weight: bold;" onclick="update()">&rarr;</button>
                <button style="font-size: 300%; font-weight: bold;" onclick="updateEmergency()">üö®</button>
                <button style="font-size: 300%; font-weight: bold;" onclick="copy()">‚éò</button>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5em;">
                <h2>Formular</h2>
                <div></div>
                <span class="label">ID</span><input type="text" id="igelID" />
                <span class="label">1.a Verantwortlich</span><input type="text" id="1_a" />
                <span class="label">Notfalltelefon</span><input type="text" id="phone" />
                <span class="label">1.b Wildtierart</span><input type="text" id="1_b" />
                <span class="label">1.c Wildtiername</span><input type="text" id="1_c" />
                <span class="label">2.a Funddatum</span><input type="text" id="2_a" />
                <span class="label">2.b PLZ Fundort</span><input type="text" id="2_b" />
                <span class="label">2.c Fundort</span><input type="text" id="2_c" />
                <span class="label">2.d Stra√üe Hausnummer Fundort</span><input type="text" id="2_d" />
                <span class="label">2.e Alter: juvenil/adult</span><input type="text" id="2_e" />
                <span class="label">2.f Geschlecht: m/w/u</span><input type="text" id="2_f" />
                <span class="label">2.g Gewicht_gramm</span><input type="text" id="2_g" />
                <span class="label">2.h Familie_ID</span><input type="text" id="2_h" />
                <span class="label">2.i Fundumst√§nde, z.B.Kellerschacht_Katzenopfer</span><input type="text" id="2_i" />
                <span class="label">2.j Besondere Merkmale_Markierung</span><input type="text" id="2_j" />
                <span class="label">3.a Pflegestelle</span><input type="text" id="3_a" />
                <span class="label">3.b Pflegestelle_Startdatum</span><input type="text" id="3_b" />
                <span class="label">3.c Pflegestelle_Startgewicht</span><input type="text" id="3_c" />
                <span class="label">3.d Pflegestelle_Befunde</span><input type="text" id="3_d" />
                <span class="label">3.e Pflegestelle_Ergebnis</span><input type="text" id="3_e" />
            </div>
        </div>
    </div>
    <script>
        document.getElementById('input-text').value = "";

        function paste() {
            console.log("paste detected");
            update();
        }

        function extractHeading(text) {
            const regex = /(\d+)\.([a-z])/;
            const match = regex.exec(text);
            if (match) {
                return [match[1], match[2]];
            }
            return null;
        }

        let ids = [ "igelID", "1_a", "phone", "1_b", "1_c", "2_a", "2_b", "2_c", "2_d", "2_e", "2_f", "2_g", "2_h", "2_i", "2_j", "3_a", "3_b", "3_c", "3_d", "3_e"];
        function clearInputs() {
            document.getElementById('input-text').value = "";
            for (let id of ids) {
                document.getElementById(id).value = "";
            }
        }
        clearInputs();

        function update() {
            let text = document.getElementById('input-text').value;
            text = text.replace(/\*/g, ""); //Remove bold formatting
            document.getElementById('input-text').value = text;
            //console.log("text", text)

            let lines = text.split("\n").map(l => l.trim()).filter(l => l.length >= 1);
            //filter out seperators
            lines = lines.filter(l => {
                if (l.split('').every(c => c == "_" || c == "-")) {
                    return false;
                } else {
                    return true;
                }
            });
            console.log(lines);
            let activeSection = null;
            for (let line of lines) {
                let line_as_number = parseInt(line);
                if (!isNaN(line) && activeSection === null) {
                    if(line.startsWith("2025") || line.startsWith("2024")){
                        line = line.substring(4);
                        line_as_number = parseInt(line);
                        document.getElementById('igelID').value = line_as_number;
                    }
                } else {
                    let heading = extractHeading(line);
                    console.log(line, heading);
                    if (heading !== null) {
                        activeSection = heading[0] + "_" + heading[1];
                        document.getElementById(activeSection).value = "";
                    } else {
                        if (activeSection !== null) {
                            document.getElementById(activeSection).value += line.trim();
                        } else {
                            console.warn("Unmatched line: ", line);
                        }
                    }
                }
            }
            copy();
        }

        function extractEmergencyHeading(text) {
            const regex = /(\d+)\.\D/;
            const match = regex.exec(text);
            if (match) {
                return match[1];
            }
            return null;
        }

        function updateEmergency() {
            let text = document.getElementById('input-text').value;
            text = text.replace(/\*/g, ""); //Remove bold formatting
            document.getElementById('input-text').value = text;
            //console.log("text", text)

            let lines = text.split("\n").map(l => l.trim()).filter(l => l.length >= 1);
            //filter out seperators
            lines = lines.filter(l => {
                if (l.split('').every(c => c == "_" || c == "-")) {
                    return false;
                } else {
                    return true;
                }
            });
            console.log(lines);
            let activeSection = null;
            for (let line of lines) {
                let line_as_number = parseInt(line);
                if (!isNaN(line) && activeSection === null) {
                    if(line.startsWith("2025") || line.startsWith("2024")){
                        line = line.substring(4);
                        line_as_number = parseInt(line);
                        document.getElementById('igelID').value = line_as_number;
                        document.getElementById('phone').value = "N";
                    }
                } else {
                    let heading = extractEmergencyHeading(line);
                    let heading_lookup = {
                        "1": "2_a",
                        "2": "2_b",
                        "3": "2_d",
                        "5": "1_b",
                        "6": "2_e",
                        "7": "2_g",
                        "8": "2_i",
                        "10": "2_j"
                    };
                    console.log(line, heading, heading_lookup[heading]);
                    if (heading !== null) {
                        if(heading_lookup.hasOwnProperty(heading)){
                            activeSection = heading_lookup[heading + ""];
                            console.log("Entered section ", activeSection);
                            document.getElementById(activeSection).value = "";
                        }else{
                            activeSection = null;
                        }
                    } else {
                        if (activeSection !== null) {
                            if(document.getElementById(activeSection).value.length > 0){
                                document.getElementById(activeSection).value += " ";
                            }
                            document.getElementById(activeSection).value += line.trim();
                        } else {
                            console.warn("Unmatched line: ", line);
                        }
                    }
                }
            }
            //Parse PLZ and fundort differently
            let plz_fundort = (document.getElementById('2_b').value + "").trim().split(" ");
            document.getElementById('2_b').value = plz_fundort[0];
            document.getElementById('2_c').value = plz_fundort[1];
            copy();
        }

        function copy(){
            let copied = ids.map(id => document.getElementById(id).value).join("\t") + "\n";
            navigator.clipboard.writeText(copied);
        }
    </script>
</body>

</html>